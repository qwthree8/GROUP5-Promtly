{% extends "base.html" %}
{% block title %}Sohbet | PromptlyAI{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col bg-gray-50">
  <!-- Başlık -->
  <header class="bg-white shadow py-6">
    <h2 class="text-3xl font-extrabold text-center">Yapay Zekâ Asistanı</h2>
  </header>

  <!-- Sektör & Örnek Soru / Konu Başlıkları -->
  <section class="bg-white border-b px-6 py-8 max-w-5xl mx-auto w-full">
    <form id="sektor-form" class="flex flex-col sm:flex-row gap-4 mb-6">
      <input
        id="sektor-input"
        type="text"
        placeholder="Sektör (örn: yazılımcı)"
        class="flex-1 border border-gray-300 px-4 py-2 rounded-lg focus:ring-purple-500 focus:border-purple-500"
      />
      <button type="submit" class="btn-primary">Örnekleri Getir</button>
    </form>

    <!-- Örnek Soru Butonları (6 adet) -->
    <div id="soru-butons" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6"></div>

    <!-- Sık Sorulanlar -->
    <p class="text-lg font-semibold mb-4">Sık Sorulanlar</p>
    <div id="konu-listesi" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
      {% if initialTopics %}
        {% set colors = [
          'bg-[var(--topic-color-1)] hover:bg-[var(--topic-hover-1)]',
          'bg-[var(--topic-color-2)] hover:bg-[var(--topic-hover-2)]',
          'bg-[var(--topic-color-3)] hover:bg-[var(--topic-hover-3)]',
          'bg-[var(--topic-color-4)] hover:bg-[var(--topic-hover-4)]'
        ] %}
        {% for kt in initialTopics %}
        <button
          type="button"
          data-color-index="{{ loop.index0 }}"
          onclick="loadTopic('{{ kt }}', {{ loop.index0 }})"
          class="w-full px-4 py-3 rounded-lg text-left font-bold text-white transition {{ colors[loop.index0] }}"
        >
          {{ kt }}
        </button>
        {% endfor %}
      {% else %}
        <p class="col-span-full text-gray-500 italic">Lütfen önce bir sektör giriniz.</p>
      {% endif %}
    </div>
  </section>

  <!-- Sohbet Geçmişi -->
  <section id="chat-box"
           class="flex-1 overflow-y-auto bg-gray-100 px-6 py-8 space-y-4 max-w-5xl mx-auto w-full"
           style="max-height: 60vh;">
    {% for msg, res in history %}
    <div>
      <div class="bg-blue-100 p-3 rounded-lg"><strong>Sen:</strong> {{ msg }}</div>
      <div class="bg-white p-3 rounded-lg shadow-sm mt-1"><strong>Bot:</strong> {{ res }}</div>
    </div>
    {% endfor %}
  </section>

  <!-- Yeni Mesaj & Prompt İyileştir -->
  <section class="bg-white border-t px-6 py-6 max-w-5xl mx-auto w-full space-y-4">
    <form id="chat-form" class="flex flex-col sm:flex-row gap-4">
      <input
        id="message-input"
        name="message"
        type="text"
        placeholder="Mesajınızı yazın..."
        class="flex-1 border border-gray-300 px-4 py-2 rounded-lg focus:ring-blue-500 focus:border-blue-500"
      />
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">Gönder</button>
    </form>

    <button id="btn-improve"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition">
      ⚡ Promptu İyileştir
    </button>

    <div id="puanlama-sonucu" class="text-gray-800 text-sm"></div>
    <div id="yeni-oneriler" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
  </section>
</div>

<script>
  const chatBox = document.getElementById('chat-box');
  const msgInput = document.getElementById('message-input');

  const topicColors = [
    ['bg-[var(--topic-color-1)]','hover:bg-[var(--topic-hover-1)]'],
    ['bg-[var(--topic-color-2)]','hover:bg-[var(--topic-hover-2)]'],
    ['bg-[var(--topic-color-3)]','hover:bg-[var(--topic-hover-3)]'],
    ['bg-[var(--topic-color-4)]','hover:bg-[var(--topic-hover-4)]']
  ];

  function scrollBottom(){
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
  }

  function selectQuestion(q){
    msgInput.value = q;
    msgInput.focus();
  }

  async function loadTopic(topic, colorIndex){
    const resp = await fetch(`/topic-ornekleri?topic=${encodeURIComponent(topic)}`);
    const { sorular } = await resp.json();
    renderQuestions(sorular, colorIndex);
  }

  function renderQuestions(list, colorIndex = null){
    const cont = document.getElementById('soru-butons');
    cont.innerHTML = '';
    list.slice(0,6).forEach(q => {
      const btn = document.createElement('button');
      let base = 'w-full px-4 py-3 rounded-lg text-sm text-left transition font-bold text-white';
      if (colorIndex !== null && topicColors[colorIndex]) {
        base += ' ' + topicColors[colorIndex].join(' ');
      } else {
        base += ' bg-gray-200 hover:bg-gray-300 text-black font-normal';
      }
      btn.className = base;
      btn.textContent = q;
      btn.onclick = () => selectQuestion(q);
      cont.appendChild(btn);
    });
  }

  document.getElementById('sektor-form').addEventListener('submit', async e => {
    e.preventDefault();
    const sec = document.getElementById('sektor-input').value.trim();
    if (!sec) return;
    const r = await fetch(`/sektor-ornekleri?sektor=${encodeURIComponent(sec)}`);
    const { sorular, konular } = await r.json();
    renderQuestions(sorular, null);

    const kdiv = document.getElementById('konu-listesi');
    kdiv.innerHTML = '';
    konular.forEach((kt,i) => {
      const [bg, hover] = topicColors[i] || topicColors[0];
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `w-full px-4 py-3 rounded-lg text-left font-bold text-white transition ${bg} ${hover}`;
      btn.textContent = kt;
      btn.onclick = () => loadTopic(kt, i);
      kdiv.appendChild(btn);
    });
  });

  document.getElementById('chat-form').addEventListener('submit', async e => {
    e.preventDefault();
    const msg = msgInput.value.trim();
    if (!msg) return;
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message: msg})
    });
    const data = await res.json();
    chatBox.insertAdjacentHTML('beforeend', `
      <div>
        <div class="bg-blue-100 p-3 rounded-lg"><strong>Sen:</strong> ${data.message}</div>
        <div class="bg-white p-3 rounded-lg shadow-sm mt-1"><strong>Bot:</strong> ${data.response}</div>
      </div>`);
    scrollBottom();
    renderQuestions(data.yeni_oneriler, null);
    msgInput.value = '';
    msgInput.focus();
  });

  document.getElementById('btn-improve').addEventListener('click', async () => {
    const text = msgInput.value.trim();
    if (!text) return;
    const resp = await fetch('/prompt-iyilestir', {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({mesaj:text})
    });
    const j = await resp.json();
    msgInput.value = j.yeni;
    document.getElementById('puanlama-sonucu').innerHTML = `
      <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg">
        <strong>Puan:</strong> ${j.puan}/100<br>
        <strong>Öneri:</strong> ${j.oneri}
      </div>`;
    renderQuestions(j.yeni_oneriler, null);
    scrollBottom();
    msgInput.focus();
  });

  window.addEventListener('load', scrollBottom);
</script>
{% endblock %}
