{# templates/chat.html #}
{% extends "base.html" %}
{% block title %}Sohbet | PromptlyAI{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col bg-gray-50">
  <!-- BaÅŸlÄ±k -->
  <header class="bg-white shadow py-6">
    <h2 class="text-3xl font-extrabold text-center">Yapay ZekÃ¢ AsistanÄ±</h2>
  </header>

  <!-- SektÃ¶r ve Ã–rnek Soru / Konu BaÅŸlÄ±klarÄ± -->
  <section class="bg-white border-b px-6 py-8 max-w-5xl mx-auto w-full">
    <form id="sektor-form" class="flex flex-col sm:flex-row gap-4 mb-6">
      <input
        id="sektor-input"
        type="text"
        placeholder="SektÃ¶r (Ã¶rn: yazÄ±lÄ±mcÄ±)"
        class="flex-1 border border-gray-300 px-4 py-2 rounded-lg focus:ring-purple-500 focus:border-purple-500"
      />
      <button
        type="submit"
        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg"
      >
        ðŸ“Œ Ã–rnekleri Getir
      </button>
    </form>

    <!-- 6 Ã–rnek Prompt ButonlarÄ± -->
    <div id="soru-butons" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      {% for q in initialQuestions %}
        <button
          class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-3 rounded-lg whitespace-normal text-sm text-left"
          onclick="selectQuestion('{{ q }}')"
        >{{ q }}</button>
      {% endfor %}
    </div>

    <!-- SÄ±k Sorulanlar BaÅŸlÄ±ÄŸÄ± -->
    <p class="text-lg font-semibold mb-4">SÄ±k Sorulanlar</p>
    <div id="konu-listesi" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      {% for kt in initialTopics %}
        <button
          class="w-full bg-yellow-100 hover:bg-yellow-200 px-4 py-3 rounded-lg text-left font-medium"
          onclick="loadTopic('{{ kt }}')"
        >{{ kt }}</button>
      {% endfor %}
    </div>
  </section>

  <!-- Sohbet Kutusu (scrollable) -->
  <section
    id="chat-box"
    class="flex-1 overflow-y-auto bg-gray-100 px-6 py-8 space-y-4 max-w-5xl mx-auto w-full"
    style="max-height: 60vh;"
  >
    {% for msg, res in history %}
      <div>
        <div class="bg-blue-100 p-3 rounded-lg"><strong>Sen:</strong> {{ msg }}</div>
        <div class="bg-white p-3 rounded-lg shadow-sm mt-1"><strong>Bot:</strong> {{ res }}</div>
      </div>
    {% endfor %}
  </section>

  <!-- Yeni Mesaj & Puanlama -->
  <section class="bg-white border-t px-6 py-6 max-w-5xl mx-auto w-full space-y-4">
    <form id="chat-form" class="flex flex-col sm:flex-row gap-4">
      <input
        id="message-input"
        name="message"
        type="text"
        placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."
        class="flex-1 border border-gray-300 px-4 py-2 rounded-lg focus:ring-blue-500 focus:border-blue-500"
      />
      <button
        type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg"
      >GÃ¶nder</button>
    </form>

    <button
      id="btn-improve"
      class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg"
    >âš¡ Promptu Ä°yileÅŸtir</button>

    <!-- Prompt Puanlama ve Ã–neri -->
    <div id="puanlama-sonucu" class="text-gray-800 text-sm"></div>

    <!-- Yeni YÃ¶nlendirici Sorular -->
    <div id="yeni-oneriler" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
  </section>
</div>

<script>
  const chatBox = document.getElementById('chat-box');
  const msgInput = document.getElementById('message-input');
  const puanDiv  = document.getElementById('puanlama-sonucu');

  function scrollBottom() {
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
  }

  function selectQuestion(q) {
    msgInput.value = q;
    msgInput.focus();
  }

  async function loadTopic(topic) {
    const resp = await fetch(`/topic-ornekleri?topic=${encodeURIComponent(topic)}`);
    const { sorular } = await resp.json();
    renderQuestions(sorular);
  }

  function renderQuestions(list) {
    const cont = document.getElementById('soru-butons');
    cont.innerHTML = '';
    list.slice(0, 6).forEach(q => {
      const btn = document.createElement('button');
      btn.className = 'w-full bg-gray-200 hover:bg-gray-300 px-4 py-3 rounded-lg whitespace-normal text-sm text-left';
      btn.textContent = q;
      btn.onclick = () => selectQuestion(q);
      cont.appendChild(btn);
    });
  }

  document.getElementById('sektor-form').addEventListener('submit', async e => {
    e.preventDefault();
    const sec = document.getElementById('sektor-input').value.trim();
    if (!sec) return;
    const r = await fetch(`/sektor-ornekleri?sektor=${encodeURIComponent(sec)}`);
    const { sorular, konular } = await r.json();
    renderQuestions(sorular);
    const kdiv = document.getElementById('konu-listesi');
    kdiv.innerHTML = '';
    konular.forEach(kt => {
      const btn = document.createElement('button');
      btn.className = 'w-full bg-yellow-100 hover:bg-yellow-200 px-4 py-3 rounded-lg text-left font-medium';
      btn.textContent = kt;
      btn.onclick = () => loadTopic(kt);
      kdiv.appendChild(btn);
    });
  });

  document.getElementById('chat-form').addEventListener('submit', async e => {
    e.preventDefault();
    const msg = msgInput.value.trim();
    if (!msg) return;
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: msg})
    });
    const data = await res.json();

    // Mesaj ve cevap ekle
    chatBox.insertAdjacentHTML('beforeend', `
      <div>
        <div class="bg-blue-100 p-3 rounded-lg"><strong>Sen:</strong> ${data.message}</div>
        <div class="bg-white p-3 rounded-lg shadow-sm mt-1"><strong>Bot:</strong> ${data.response}</div>
      </div>
    `);

    // Puanlama ve Ã¶neri gÃ¶ster
    puanDiv.innerHTML = `
      <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mt-2">
        <strong>Puan:</strong> ${data.score}/100<br>
        <strong>Ã–neri:</strong> ${data.suggestion}
      </div>
    `;

    // Yeni yÃ¶nlendirici sorular
    renderQuestions(data.yeni_oneriler);

    // KaydÄ±r
    scrollBottom();
    msgInput.value = '';
    msgInput.focus();
  });

  document.getElementById('btn-improve').addEventListener('click', async () => {
    const text = msgInput.value.trim();
    if (!text) return;
    const resp = await fetch('/prompt-iyilestir', {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({mesaj: text})
    });
    const j = await resp.json();

    // GÃ¼ncellenmiÅŸ prompt
    msgInput.value = j.yeni;

    // Puanlama yenile
    puanDiv.innerHTML = `
      <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mt-2">
        <strong>Puan:</strong> ${j.puan}/100<br>
        <strong>Ã–neri:</strong> ${j.oneri}
      </div>
    `;

    // Yeni Ã¶neriler
    renderQuestions(j.yeni_oneriler);

    scrollBottom();
    msgInput.focus();
  });

  window.addEventListener('load', scrollBottom);
</script>
{% endblock %}
